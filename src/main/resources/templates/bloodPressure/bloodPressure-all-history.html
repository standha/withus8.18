<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="kr">
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>위더스</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no">
    <link  th:href="@{/css/jquery-ui.css}" rel="stylesheet">
    <link th:href="@{/css/reset.css}" rel="stylesheet">
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/layout.css}" rel="stylesheet">
    <script th:src="@{/js/jquery-1.12.4.min.js}"></script>
    <script th:src="@{/js/chart.js}"></script>
    <script th:src="@{js/chartjs-plugin-style.min.js}"></script>
    <script th:src="@{/js/jquery-ui.js}"></script>
    <script th:src="@{/js/datepicker-ko.js}"></script>
    <script th:src="@{/js/common.js}"></script>
</head>
<body>
<div class="skip-navi">
    <a href="#content">본문 바로가기</a>
</div>

<!-- wrap -->
<div id="wrap" class="chart-page">

    <!-- header -->
    <header>
        <div class="header-wrap type01">
            <div class="head">
                <a class="btn xsm type07" href="javascript:void(0)">
                    <span class="ico-call"></span>
                    <span class="txt-rt">도우미</span>
                </a>
                <h2>
                    <span class="ico-blood-s"></span>
                    <span>혈압/맥박</span>
                </h2>
            </div>
        </div>
    </header>
    <!-- // header -->

    <!-- content -->
    <div class="container" id="content">
        <div class="cont-wrap type01">
            <div class="chart-wrap">
                <div class="chart-legend">
                    <span class="tit">mmHg, 회/분</span>
                    <ul class="list">
                        <li class="red">수축기 혈압</li>
                        <li class="blue">이완기 혈압</li>
                        <li class="black">맥박</li>
                    </ul>
                </div>
                <canvas id="myChart" class="chart-blood" style="height:70vw; width:100vw"></canvas>
                <div class="tbl-chart">
                    <div class="tbl-wrap type01">
                        <table>
                            <thead id="history-table-day">
                            </thead>
                            <tbody id="history-table-data"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- // content -->

</div>
<!--// wrap -->

<script th:inline="javascript">

    /*<![CDATA[*/
    var bloodRecord = /*[[ ${bloodWeek} ]]*/;
    /*]]*/

    var date = [];
    var contraction = [];
    var relaxation = [];
    var pressure = [];

    //요일 데이터 테이블
    var rowItem = "<tr><th></th>";
    var week = ['일', '월', '화', '수', '목', '금', '토'];
    for(i=0; i<bloodRecord.length; i++)
    {
        var day = new Date(bloodRecord[i].pk.date.substr(0, 4), bloodRecord[i].pk.date.substr(5, 2)-1, bloodRecord[i].pk.date.substr(8, 2)).getDay();
        var dayLabel = week[day];
        rowItem += "<th>" + dayLabel + "</th>";
    }
    rowItem += "</tr>"
    $('#history-table-day').append(rowItem);

    //수축기 이완기 데이터 테이블
    var bloodItem = "<tr>";
    bloodItem += "<th><span class=\"bold\">혈압</span><span>mmHg</span></th>";
    for(i=0; i<bloodRecord.length; i++)
    {
        bloodItem += "<td>";
        bloodItem += "<span class=\"red\">" + bloodRecord[i].contraction + "</span>";
        bloodItem += "<span class=\"blue\">" + bloodRecord[i].relaxation + "</span>";
        bloodItem += "</td>";
    }
    bloodItem += "</tr>"
    $('#history-table-data').append(bloodItem);

    //혈압 데이터 테이블
    var pulse = "<tr>";
    pulse += "<th><span class=\"bold\">맥박</span><span>회/분</span></th>";
    for(i=0; i<bloodRecord.length; i++)
    {
        pulse += "<td>";
        pulse += "<span class=\"black\">" + bloodRecord[i].pressure + "</span>";
        pulse += "</td>";
    }
    pulse += "</tr>"
    $('#history-table-data').append(pulse);

    for(i=0; i<bloodRecord.length; i++)
    {
        //x축 라벨 바꾸기
        date[i] = bloodRecord[i].pk.date.substr(5,5);
        //date[i] = bloodRecord[i].pk.date;
        contraction[i] = bloodRecord[i].contraction;
        relaxation[i] = bloodRecord[i].relaxation;
        pressure[i] = bloodRecord[i].pressure;
    }

    let draw = Chart.controllers.line.prototype.draw;
    var ctx = document.getElementById('myChart').getContext('2d');
    var data = {
        labels: date,
        datasets: [{
            label: '수축기 혈압',
            data: contraction,
            fill: true,
            spanGaps: false,
            borderWidth: 2,
            borderColor: '#fc4d4d',
            pointBackgroundColor: '#fc4d4d',
            pointBorderColor: '#fc4d4d',
            pointRadius: 1.5
        },{
            label: '이완기 혈압',
            data: relaxation,
            fill: true,
            spanGaps: false,
            borderWidth: 2,
            borderColor: '#3ca5ff',
            pointBackgroundColor: '#3ca5ff',
            pointBorderColor: '#3ca5ff',
            pointRadius: 1.5
        },{
            label: '맥박',
            data: pressure,
            fill: true,
            spanGaps: false,
            borderWidth: 2,
            borderColor: '#515558',
            pointBackgroundColor: '#515558',
            pointBorderColor: '#515558',
            pointRadius: 1.5
        }
        ]
    };
    var myPlugin = {
        id: 'lineDraw',
        afterDraw (chart, easing) {
            if (chart.config.options && chart.config.options.scales) {
                if (chart.config.options.scales.xAxes) {
                    chart.config.options.scales.xAxes.forEach(function (xAxisConfig) {
                        if (!xAxisConfig.color) {
                            return
                        }

                        var chartArea = chart.chartArea
                        var xAxis = chart.scales[xAxisConfig.id]

                        // just draw the scale again with different colors
                        var color = xAxisConfig.gridLines.color
                        xAxisConfig.gridLines.color = xAxisConfig.color
                        xAxis.draw(chartArea)
                        xAxisConfig.gridLines.color = color
                    })
                }
                if (chart.config.options.scales.yAxes) {
                    chart.config.options.scales.yAxes.forEach(function (yAxisConfig) {
                        if (!yAxisConfig.color) {
                            return
                        }

                        var ctx = chart.chart.ctx
                        var chartArea = chart.chartArea
                        var yAxis = chart.scales[yAxisConfig.id]

                        // here, since we also have the grid lines, set a clip area for the left of the y axis
                        ctx.save()
                        ctx.rect(0, 0, chartArea.left + yAxisConfig.gridLines.lineWidth - 1, chartArea.bottom + yAxisConfig.gridLines.lineWidth - 1)
                        ctx.clip()

                        var color = yAxisConfig.gridLines.color
                        yAxisConfig.gridLines.color = yAxisConfig.color
                        yAxis.draw(chartArea)
                        yAxisConfig.gridLines.color = color

                        ctx.restore()
                    })
                }
                // we need to draw the tooltip so that it comes over the (redrawn) elements
                chart.tooltip.transition(easing).draw()
            }
        }
    }

    var myChart = new Chart(ctx, {
        plugins: [
            {
                id: "responsiveGradient",
                afterLayout: function(chart, options) {
                    var scales = chart.scales;

                    // create a linear gradient with the dimentions of the scale
                    var color = chart.ctx.createLinearGradient(0,scales["y-axis-0"].bottom,0,0);
                    // add gradients stops
                    color.addColorStop(0, "rgba(252,77,77,0)");
                    color.addColorStop(0.25, "rgba(252,77,77,0)");
                    color.addColorStop(0.5, "rgba(252,77,77,0)");
                    color.addColorStop(0.75, "rgba(252,77,77,0.1)");
                    color.addColorStop(1, "rgba(252,77,77,0.7)");

                    // create a linear gradient with the dimentions of the scale
                    var color1 = chart.ctx.createLinearGradient(0,scales["y-axis-0"].bottom,0,0);
                    // add gradients stops
                    color1.addColorStop(0, "rgba(60,165,255,0)");
                    color1.addColorStop(0.25, "rgba(60,165,255,0)");
                    color1.addColorStop(0.5, "rgba(60,165,255,0)");
                    color1.addColorStop(0.75, "rgba(60,165,255,0.1)");
                    color1.addColorStop(1, "rgba(60,165,255,0.7)");

                    // create a linear gradient with the dimentions of the scale
                    var color2 = chart.ctx.createLinearGradient(0,scales["y-axis-0"].bottom,0,0);
                    // add gradients stops
                    color2.addColorStop(0, "rgba(81,85,88,0)");
                    color2.addColorStop(0.25, "rgba(81,85,88,0)");
                    color2.addColorStop(0.5, "rgba(81,85,88,0.1)");
                    color2.addColorStop(0.75, "rgba(81,85,88,0.1)");
                    color2.addColorStop(1, "rgba(81,85,88,0.7)");

                    // changes the background color option
                    chart.data.datasets[0].backgroundColor = color;
                    chart.data.datasets[1].backgroundColor = color1;
                    chart.data.datasets[2].backgroundColor = color2;
                }
            }
        ],
        // The type of chart we want to create
        type: 'line',

        // The data for our dataset
        data: data,

        // Configuration options go here
        options: {
            scales:{
                yAxes:[{
                    ticks: {
                        beginAtZero: true,
                        min: 0,
                        max: 200,
                        stepSize: 25,
                        maxTicksLimit: 9,
                        callback: function(value, index, values) {
                            return value == 0 || value == 50 || value == 100 || value == 150 || value == 200?value:'';
                        }
                    }
                }]
                // ,
                // xAxes:[{
                //     gridLines: {
                //         display: false
                //     }
                // }]
            },
            legend: {
                display: false,
                position: 'top',
                align: 'right', // 안먹음 ㅠㅠ
                fullWidth: false,
                labels: {
                    usePointStyle: true,
                    fontSize: 13,
                    fontStyle: '',
                    padding: 30
                }
            }
        }
    });

</script>

</body>
</html>
