<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="kr">
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>위더스</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
	<meta name="format-detection" content="telephone=no">
	<link  th:href="@{/css/jquery-ui.css}" rel="stylesheet">
	<link th:href="@{/css/reset.css}" rel="stylesheet">
	<link th:href="@{/css/common.css}" rel="stylesheet">
	<link th:href="@{/css/layout.css}" rel="stylesheet">
	<script th:src="@{/js/jquery-1.12.4.min.js}"></script>
	<script th:src="@{/js/jquery-ui.js}"></script>
	<script th:src="@{/js/datepicker-ko.js}"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
	<script th:src="@{/js/common.js}"></script>
	<script th:src="@{/js/help.js}"></script>
</head>
<body>
<input type="hidden" id="button-count" th:attr="value=@{/button-count}">
<input type="hidden" id="helper-request" th:attr="value=@{/helper-request}">
<div class="skip-navi">
	<a href="#content">본문 바로가기</a>
</div>
<div th:if="${type} == ${T(withus.entity.User.Type).PATIENT} and ${week} != 25 ">
	<input type = 'hidden' name = "symptom"           th:value = "${count.symptom}" style = "display:none">
	<input type = 'hidden' name = "alarm"             th:value = "${count.alarm}" style = "display:none">
	<input type = 'hidden' name = "bloodPressure"             th:value = "${count.bloodPressure}" style = "display:none">
	<input type = 'hidden' name = "diseaseInfo"           th:value = "${count.diseaseInfo}" style = "display:none">
	<input type = 'hidden' name = "exercise"          th:value = "${count.exercise}" style = "display:none">
	<input type = 'hidden' name = "goal"              th:value = "${count.goal}" style = "display:none">
	<input type = 'hidden' name = "helper"            th:value = "${count.helper}" style = "display:none">
	<input type = 'hidden' name = "level"             th:value = "${count.level}" style = "display:none">
	<input type = 'hidden' name = "natriumMoisture"   th:value = "${count.natriumMoisture}" style = "display:none">
	<input type = 'hidden' name = "weight"            th:value = "${count.weight}" style = "display:none">
	<input type = 'hidden' name = "withusRang"        th:value = "${count.withusRang}" style = "display:none">
	<input type = 'hidden' name = "medicine"        th:value = "${count.medicine}" style = "display:none">
	<input type = 'hidden' name = "board"        th:value = "${count.board}" style = "display:none">
	<input type = 'hidden' name = "infoEdit"        th:value = "${count.infoEdit}" style = "display:none">
	<input type = 'hidden' name = "mindHealth"        th:value = "${count.mindHealth}" style = "display:none">
</div>
<div th:if="${type} == ${T(withus.entity.User.Type).CAREGIVER} and ${week} != 25 ">
	<input type = 'hidden' name = "alarm"             th:value = "${count.alarm}" style = "display:none">
	<input type = 'hidden' name = "bloodPressure"             th:value = "${count.bloodPressure}" style = "display:none">
	<input type = 'hidden' name = "diseaseInfo"           th:value = "${count.diseaseInfo}" style = "display:none">
	<input type = 'hidden' name = "exercise"          th:value = "${count.exercise}" style = "display:none">
	<input type = 'hidden' name = "goal"              th:value = "${count.goal}" style = "display:none">
	<input type = 'hidden' name = "helper"            th:value = "${count.helper}" style = "display:none">
	<input type = 'hidden' name = "level"             th:value = "${count.level}" style = "display:none">
	<input type = 'hidden' name = "weight"            th:value = "${count.weight}" style = "display:none">
	<input type = 'hidden' name = "withusRang"        th:value = "${count.withusRang}" style = "display:none">
	<input type = 'hidden' name = "familyObservation"        th:value = "${count.familyObservation}" style = "display:none">
	<input type = 'hidden' name = "dietManagement"        th:value = "${count.dietManagement}" style = "display:none">
	<input type = 'hidden' name = "mindHealth"        th:value = "${count.mindHealth}" style = "display:none">
	<input type = 'hidden' name = "board"        th:value = "${count.board}" style = "display:none">
	<input type = 'hidden' name = "infoEdit"        th:value = "${count.infoEdit}" style = "display:none">
	<input type = 'hidden' name = "medicine"           th:value = "${count.medicine}" style = "display:none">
</div>
<!-- wrap -->
<div id="wrap" class="chart-page">

	<!-- header -->
	<header>
		<div class="header-wrap type01">
			<div class="head" th:if="${type} == ${T(withus.entity.User.Type).PATIENT} and ${week} != 25 ">
				<div onclick="helperRequest()" >
					<a class="btn xsm type07" href="tel:010-8454-9186" onclick="addHelper()" >
						<span class="ico-call" ></span>
						<span class="txt-rt">도우미</span>
					</a>
				</div>
				<h2>
					<span class="ico-weight-s"></span>
					<span>체중 변화</span>
				</h2>
			</div>
			<div class="head" th:if="${type} == ${T(withus.entity.User.Type).CAREGIVER} or ${week} == 25">
				<div onclick="helperRequest()" >
					<a class="btn xsm type07" href="tel:010-8454-9186">
						<span class="ico-call" ></span>
						<span class="txt-rt">도우미</span>
					</a>
				</div>
				<h2>
					<span class="ico-weight-s"></span>
					<span>체중 변화</span>
				</h2>
			</div>
		</div>
	</header>
	<!-- // header -->

	<!-- content -->
	<div class="container" id="content">
		<div class="cont-wrap type01">
			<div class="chart-wrap">
				<div class="chart-legend">
					<span class="tit">Kg</span>
					<ul class="list">
						<li class="green">체중</li>
					</ul>
				</div>
				<canvas id="myChart" class="chart-blood" style="height:90vw; width:100vw"></canvas>
				<div class="chart-legend">
					<span class="tit"></span>
					<ul class="list">
						<li >(일)</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="cont-wrap type01">
			<div id="dateRecord" class="size-lg"></div>
		</div>
	</div>
	<!-- // content -->

</div>
<!--// wrap -->

<script th:inline="javascript">

	$.datepicker._generateHTML = (function (){
		var realGenerateHtml = $.datepicker._generateHTML;
		return function (instance) {
			var html = realGenerateHtml.apply(this, arguments), $temp;

			if ( instance.input.is(".size-lg") ) {
				$temp = $("<table></table>").append(html);
				$temp.find(".ui-datepicker-title").each(function () {

					var year = $(this).find('.ui-datepicker-year').text();
					var month = $(this).find('.ui-datepicker-month').data();
					var day = $(this).find('.ui-datepicker-day').text();

					var monthStr, dayStr;
					monthStr = (month+1).toString();
					if(monthStr.length == 1){
						monthStr = "0" + monthStr;
					}
					dayStr = day.toString();
					if(dayStr.length == 1){
						dayStr = "0" + dayStr;
					}
					var str = year.toString() + "-" + monthStr + "-" + dayStr;


					/*<![CDATA[*/
					var weightRecord = /*[[ ${weightRecord} ]]*/;
					/*]]*/

					var date = [];
					var weight = [];
					var height = /*[[ ${height} ]]*/;
					height = parseInt(height);

					const underWeightMax = height* height / 10000 * 18.5;
					const normalWeightMax = height*height / 10000 * 23;
					const overWeightMax = height*height / 10000 * 25;
					console.log(underWeightMax);
					var j = 0;
					for(i=0; i<weightRecord.length; i++)
					{
						if(str == weightRecord[i].pk.date.substr(0, 7))
						{
							date[j] = weightRecord[i].pk.date.substr(8, 2);
							weight[j] = weightRecord[i].weight;
							j++;
						}
					}
					var ctx = document.getElementById('myChart').getContext('2d');
					var data = {
						labels: date,
						datasets: [{
							label: '체중',
							data: weight,
							fill: true,
							spanGaps: false,
							borderWidth: 2,
							borderColor: '#21bc97',
							pointBackgroundColor: '#21bc97',
							pointBorderColor: '#21bc97',
							pointRadius: 1.5
						}]
					};

					var myChart = new Chart(ctx, {
						type: 'line',
						data: data,
						options: {
							scales:{
								y:{
									min: function(){
										if(weight.length === 0){
											return 20;
										} else {
											return weight[0] -5;
										}
									},
									max:function(){
										if(weight.length === 0){
											return 110;
										} else {
											return weight[0] +5;
										}
									},
								}
							},
							plugins: {
								annotation: {
									annotations: {
										box1: {
											type: 'box',
											xMin: 0,
											xMax: 31,
											yMin: 20,
											yMax: underWeightMax,
											backgroundColor: 'rgb(255,255,65,0.25)',
											borderWidth: 0
										},
										box2: {
											type: 'box',
											xMin: 0,
											xMax: 31,
											yMin: underWeightMax,
											yMax: normalWeightMax,
											backgroundColor: 'rgba(109,197,37,0.25)',
											borderWidth: 0
										},
										box3: {
											type: 'box',
											xMin: 0,
											xMax: 31,
											yMin: normalWeightMax,
											yMax: overWeightMax,
											backgroundColor: 'rgba(239,115,30,0.25)',
											borderWidth: 0
										},
										box4: {
											type: 'box',
											xMin: 0,
											xMax: 31,
											yMin: overWeightMax,
											yMax: 200,
											backgroundColor: 'rgba(255,26,26,0.25)',
											borderWidth: 0
										}
									}
								},
								legend: {
									display: false
								},
								tooltip:{
									enabled:false
								}
							}
						}
					});
				});
				html = $temp[0].innerHTML;
			}

			return html;
		};
	})();


	$( function() {
		$( "#dateRecord" ).datepicker();
	} );


</script>

</body>
</html>
